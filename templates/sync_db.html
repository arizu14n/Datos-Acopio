{% extends 'base.html' %}

{% block title %}Sincronizar Base de Datos{% endblock %}

{% block head_extra %}
    <style>
        .sync-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        .btn {
            font-size: 1.2rem;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
        }
        #sync-status {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            display: none; /* Oculto por defecto */
            margin: 1rem auto;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="sync-container">
    <h1>Sincronizar Base de Datos</h1>
    <p>Selecciona el tipo de sincronización que deseas realizar.</p>
    
    <div class="my-3">
        <button id="sync-button" class="btn btn-primary">Sincronización Completa (Lento)</button>
        <p class="form-text">Borra todos los datos y los vuelve a cargar desde cero. Útil si faltan datos o hay inconsistencias.</p>
    </div>

    <div class="my-3">
        <button id="update-sync-button" class="btn btn-secondary">Sincronización Rápida (Actualizar)</button>
        <p class="form-text">Solo actualiza los registros existentes y añade los nuevos. No elimina registros borrados en el origen.</p>
    </div>
    
    <div id="spinner" class="spinner"></div>
    <div id="sync-status"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function handleSync(buttonId, url, buttonText) {
    const syncButton = document.getElementById(buttonId);
    const otherButtonId = (buttonId === 'sync-button') ? 'update-sync-button' : 'sync-button';
    const otherButton = document.getElementById(otherButtonId);
    const spinner = document.getElementById('spinner');
    const statusDiv = document.getElementById('sync-status');

    syncButton.disabled = true;
    otherButton.disabled = true;
    syncButton.textContent = 'Sincronizando...';
    spinner.style.display = 'block';
    statusDiv.textContent = '';
    statusDiv.className = '';

    fetch(url, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            statusDiv.textContent = '¡' + data.message + '!';
            statusDiv.classList.add('alert', 'alert-success');
        } else {
            statusDiv.textContent = 'Error en la sincronización: ' + data.message;
            statusDiv.classList.add('alert', 'alert-danger');
        }
    })
    .catch(error => {
        statusDiv.textContent = 'Error de red o del servidor: ' + error;
        statusDiv.classList.add('alert', 'alert-danger');
    })
    .finally(() => {
        syncButton.disabled = false;
        otherButton.disabled = false;
        syncButton.textContent = buttonText;
        spinner.style.display = 'none';
    });
}

document.getElementById('sync-button').addEventListener('click', function() {
    handleSync('sync-button', '{{ url_for("sync_db") }}', 'Sincronización Completa (Lento)');
});

document.getElementById('update-sync-button').addEventListener('click', function() {
    handleSync('update-sync-button', '{{ url_for("update_sync_db") }}', 'Sincronización Rápida (Actualizar)');
});
</script>
{% endblock %}
