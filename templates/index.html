{% extends "base.html" %}
{% block title %}Ventas - Acopio{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/index.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <h2>Contratos con Saldo Pendiente de Entrega</h2>
    <div class="layout-container" style="display: flex;">
        <div style="flex: 0 0 65%;">
            <div class="table-container">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Contrato</th>
                            <th>Comprador</th>
                            <th>Grano</th>
                            <th>Cosecha</th>
                            <th>Kilos Liquidados</th>
                            <th>Kilos Liq. Ventas</th>
                            <th>Kilos Pendientes</th>
                            <th>Camiones Pendientes</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contrato in contratos_pendientes %}
                        <tr>
                            <td>{{ contrato.contrato }}</td>
                            <td class="comprador">{{ contrato.comprador }}</td>
                            <td class="grano">{{ contrato.grano }}</td>
                            <td class="cosecha">{{ contrato.cosecha }}</td>
                            <td>{{ contrato.kilos_liquidados }}</td>
                            <td>{{ format_number(contrato.kilos_liq_ventas) }}</td>
                            <td>{{ contrato.kilos_pendientes }}</td>
                            <td>{{ contrato.camiones_pendientes }}</td>
                            <td>
                                <button class="btn btn-primary btn-sm pedir-cupos-btn" 
                                        data-comprador="{{ contrato.comprador }}" 
                                        data-grano="{{ contrato.grano }}" 
                                        data-cosecha="{{ contrato.cosecha }}">
                                    Pedir Cupos
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        {% for grano, totales in totales_por_grano.items() %}
                        <tr>
                            <td colspan="7" style="text-align: right;"><strong>Total {{ grano }}:</strong></td>
                            <td><strong>{{ format_number(totales.kilos) }}</strong></td>
                            <td><strong>{{ totales.camiones }}</strong></td>
                        </tr>
                        {% endfor %}
                    </tfoot>
                </table>
            </div>
        </div>

        <div style="flex: 0 0 35%;">
            <div class="chart-container">
                <canvas id="pieChartPendientes"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-container" style="width: 80%; margin-top: 30px;">
        <canvas id="barChartStock"></canvas>
    </div>

<!-- Modal para Pedir Cupos -->
<div class="modal fade" id="pedirCuposModal" tabindex="-1" aria-labelledby="pedirCuposModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pedirCuposModalLabel">Pedir Cupos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="pedirCuposForm">
          <div class="mb-3">
            <label for="nombrePersona" class="form-label">Nombre de la Persona</label>
            <input type="text" class="form-control" id="nombrePersona" required>
          </div>
          <div class="mb-3">
            <label for="cantidadCupos" class="form-label">Cantidad</label>
            <input type="number" class="form-control" id="cantidadCupos" required>
          </div>
          <div class="mb-3">
            <label for="fechaCupo" class="form-label">Fecha</label>
            <input type="date" class="form-control" id="fechaCupo" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="aceptarCuposBtn">Aceptar</button>
      </div>
    </div>
  </div>
</div>

    <hr style="margin: 40px 0;">

    <h2>Cupos Solicitados</h2>
    <div class="table-container">
        <table class="summary-table" id="cupos-solicitados-table">
            <thead>
                <tr>
                    <th>Contrato</th>
                    <th>Grano</th>
                    <th>Cantidad</th>
                    <th>Fecha Solicitud</th>
                    <th>Codigo Cupo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for cupo in cupos_solicitados %}
                <tr data-cupo-id="{{ cupo.id }}">
                    <td>{{ cupo.contrato }}</td>
                    <td>{{ cupo.grano }}</td>
                    <td>{{ format_number(cupo.cantidad) }}</td>
                    <td>{{ cupo.fecha_solicitud }}</td>
                    <td><input type="text" class="form-control form-control-sm codigo-cupo-input" value="{{ cupo.codigo_cupo or '' }}"></td>
                    <td>
                        <button class="btn btn-info btn-sm asignar-viaje-btn">Asignar Viaje</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                {% for grano, total in totales_cupos_por_grano.items() %}
                <tr>
                    <td colspan="2" style="text-align: right;"><strong>Total {{ grano }}:</strong></td>
                    <td><strong>{{ format_number(total) }}</strong></td>
                    <td colspan="3"></td>
                </tr>
                {% endfor %}
            </tfoot>
        </table>
    </div>

    <!-- Modal para Asignar Viaje -->
    <div class="modal fade" id="asignarViajeModal" tabindex="-1" aria-labelledby="asignarViajeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="asignarViajeModalLabel">Asignar Viaje a Cupo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="asignarViajeForm">
                <input type="hidden" id="cupoIdInput" name="cupo_id">
                <div class="mb-3">
                    <label for="fleteSelect" class="form-label">Seleccionar Viaje</label>
                    <select class="form-select" id="fleteSelect" name="flete_id" required>
                        <option value="">Seleccione un flete</option>
                        {% for flete in fletes %}
                            <option value="{{ flete.id }}">{{ flete.g_fecha }} - {{ flete.g_ctg }} - {{ flete.o_neto }} kg</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmarAsignacionBtn">Asignar</button>
          </div>
        </div>
      </div>
    </div>

    <h1>Consulta de Contratos</h1>

    <form method="POST">
        <label for="g_contrato">Seleccionar Contrato:</label>
        <select id="g_contrato" name="g_contrato" onchange="this.form.submit()">
            <option value="">Seleccione un contrato</option>
            {% for contrato in contratos %}
                <option value="{{ contrato }}" {% if contrato == g_contrato_filtro %}selected{% endif %}>{{ contrato }}</option>
            {% endfor %}
        </select>
        
        {% if info_adicional %}
            <span class="info-label">Grano:</span> {{ info_adicional.grano }}
            <span class="info-label">Cosecha:</span> {{ info_adicional.cosecha }}
            {% if info_adicional.comprador %}
                <span class="info-label">Comprador:</span> {{ info_adicional.comprador }}
            {% endif %}
        {% endif %}
    </form>

    


    {% if entregas_confirmadas or entregas_no_confirmadas %}

    <h2>Resumen</h2>
        <div class="table-container">
            <table class="summary-table">
                <tbody>
                    <tr>
                        <td>Total Saldo Entregas</td>
                        <td>{{ total_saldo }}</td>
                    </tr>
                    <tr>
                        <td>Total Peso Liquidaciones</td>
                        <td>{{ totales_liq['Peso'] }}</td>
                    </tr>
                    <tr class="{% if diferencia_num > 0 %}positivo{% elif diferencia_num < 0 %}negativo{% endif %}">
                        <td><strong>Diferencia</strong></td>
                        <td><strong>{{ diferencia }}</strong></td>
                    </tr>
                    {% if diferencia_num < 0 %}
                    <tr class="negativo">
                        <td><strong>Camiones restantes:</strong></td>
                        <td><strong>{{ camiones_restantes }}</strong></td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="chart-container">
            <canvas id="comparacionChart"></canvas>
        </div>

        <div>
            <h2>Entregas</h2>
            <a href="{{ url_for('generar_pdf', tipo_reporte='entregas', contrato=g_contrato_filtro) }}" class="pdf-button">Exportar a PDF</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        {% if (entregas_no_confirmadas + entregas_confirmadas) %}
                            {% for campo in (entregas_no_confirmadas + entregas_confirmadas)[0].keys() %}
                                <th>{{ campo }}</th>
                            {% endfor %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for registro in entregas_no_confirmadas %}
                    <tr class="no-confirmada">
                        {% for valor in registro.values() %}
                            <td>{{ valor }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {% for registro in entregas_confirmadas %}
                    <tr>
                        {% for valor in registro.values() %}
                            <td>{{ valor }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="subtotal">
                        <td colspan="3">Total No Confirmadas</td>
                        <td>{{ total_no_confirmadas }}</td>
                        <td>Registros: {{ registros_no_confirmadas }}</td>
                    </tr>
                    <tr class="subtotal">
                        <td colspan="3">Total Confirmadas</td>
                        <td>{{ total_confirmadas }}</td>
                        <td>Registros: {{ registros_confirmadas }}</td>
                    </tr>
                    <tr class="grand-total">
                        <td colspan="3">Total General</td>
                        <td>{{ total_saldo }}</td>
                        <td>Registros: {{ total_registros }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    {% elif g_contrato_filtro %}
        <p>No se encontraron entregas para el contrato seleccionado.</p>
    {% endif %}

    {% if liquidaciones_filtradas %}
        <div>
            <h2>Liquidaciones</h2>
            <a href="{{ url_for('generar_pdf', tipo_reporte='liquidaciones', contrato=g_contrato_filtro) }}" class="pdf-button">Exportar a PDF</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        {% for campo in liquidaciones_filtradas[0].keys() %}
                            <th>{{ campo }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for liquidacion in liquidaciones_filtradas %}
                    <tr>
                        {% for valor in liquidacion.values() %}
                            <td>{{ valor }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                {% if totales_liq %}
                <tfoot>
                    <tr>
                        <td colspan="2">Totales ({{ total_liquidaciones }} registros)</td>
                        <td>{{ totales_liq['Peso'] }}</td>
                        <td></td> {# Columna vac√≠a para Precio #}
                        <td>{{ totales_liq['N.Grav.'] }}</td>
                        <td>{{ totales_liq['IVA'] }}</td>
                        <td>{{ totales_liq['Otros'] }}</td>
                        <td>{{ totales_liq['Total'] }}</td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>

    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    const pieChartLabels = {{ pie_chart_labels | tojson }};
    const pieChartValues = {{ pie_chart_values | tojson }};
    const barChartLabels = {{ bar_chart_labels | tojson }};
    const barChartPendientes = {{ bar_chart_pendientes | tojson }};
    const barChartStock = {{ bar_chart_stock | tojson }};
    {% if liquidaciones_filtradas %}
    const totalSaldoNum = {{ total_saldo_num | default(0) }};
    const totalPesoNum = {{ total_peso_num | default(0) }};
    {% endif %}
</script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}
