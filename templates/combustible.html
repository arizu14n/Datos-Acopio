{% extends "base.html" %}

{% block title %}Gestión de Combustible{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/fletes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/nuevo_flete.css') }}">

<div class="container-fluid">
    <h1 class="text-center my-4">Gestión de Combustible</h1>

    <!-- Resumen de Stock -->
    <div class="card mb-4">
        <div class="card-header">
            Resumen de Stock
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Proveedor</th>
                            <th>Producto</th>
                            <th>Stock Actual</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stock %}
                        <tr>
                            <td>{{ item.proveedor }}</td>
                            <td>{{ item.producto }}</td>
                            <td>{{ "%.2f" | format(item.stock) }} Lts</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center">No hay stock registrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Formulario de Nuevo Movimiento -->
    <div class="card mb-4">
        <div class="card-header">
            Registrar Nuevo Movimiento
        </div>
        <div class="card-body">
            <form action="{{ url_for('combustible') }}" method="POST" id="form-combustible">
                <div class="row g-3 mt-2">
                    <div class="col-md-2">
                        <label for="tipo_operacion" class="form-label">Tipo de Operación</label>
                        <select class="form-select" id="tipo_operacion" name="tipo_operacion" required>
                            <option value="Compra">Compra</option>
                            <option value="Retiro">Retiro</option>
                            <option value="Canje">Canje</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="proveedor" class="form-label">Proveedor</label>
                        <select class="form-select" id="proveedor" name="proveedor_id">
                            <option value="">Seleccionar Proveedor</option>
                            {% for p in proveedores %}
                            <option value="{{ p.cli_c }}">{{ p.s_apelli }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="chofer" class="form-label">Chofer Responsable</label>
                        <select class="form-select" id="chofer" name="chofer_documento" required>
                            <option value="">Seleccionar Chofer</option>
                            {% for c in choferes %}
                            <option value="{{ c.c_document }}">{{ c.c_nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="nro_comprobante" class="form-label">Nro. Comprobante</label>
                        <input type="text" class="form-control" id="nro_comprobante" name="nro_comprobante">
                    </div>
                </div>

                <hr id="canje-separator" style="display: none;"/>

                <!-- Campos para Producto Principal (Compra/Retiro) -->
                <div class="row g-3 mt-2" id="producto-principal-section">
                    <div class="col-md-2">
                        <label for="fecha_movimiento" class="form-label">Fecha del Movimiento</label>
                        <input type="date" class="form-control" id="fecha_movimiento" name="fecha_movimiento" value="" required>
                    </div>
                    <div class="col-md-4">
                        <label for="producto" class="form-label" id="producto-label">Producto</label>
                        <select class="form-select" id="producto" name="producto_id" required>
                            <option value="">Seleccionar Producto</option>
                            {% for prod in productos %}
                            <option value="{{ prod.id }}">{{ prod.nombre }}</option>
                            {% endfor %}
                        </select>
                        <a href="#" id="add-producto-link">Agregar nuevo producto</a>
                    </div>
                    <div class="col-md-3">
                        <label for="cantidad" class="form-label" id="cantidad-label">Cantidad (Lts)</label>
                        <input type="number" step="0.01" class="form-control" id="cantidad" name="cantidad" required>
                    </div>
                    <div class="col-md-3">
                        <label for="precio_unitario" class="form-label" id="precio-label">Precio Unitario</label>
                        <input type="number" step="0.01" class="form-control" id="precio_unitario" name="precio_unitario">
                    </div>
                </div>

                <!-- Campos para Canje (Producto que sale y producto que entra) -->
                <div class="row g-3 mt-2" id="canje-section" style="display: none;">
                    <!-- Producto que SALE -->
                    <div class="col-md-6 border-end">
                        <h5>Producto que SALE</h5>
                        <div class="mb-3">
                            <label for="producto_sale" class="form-label">Producto</label>
                            <select class="form-select" id="producto_sale" name="producto_sale_id">
                                <option value="">Seleccionar Producto</option>
                                {% for prod in productos %}
                                <option value="{{ prod.id }}">{{ prod.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cantidad_sale" class="form-label">Cantidad (Lts)</label>
                            <input type="number" step="0.01" class="form-control" id="cantidad_sale" name="cantidad_sale">
                        </div>
                    </div>
                    <!-- Producto que ENTRA -->
                    <div class="col-md-6">
                        <h5>Producto que ENTRA</h5>
                        <div class="mb-3">
                            <label for="producto_entra" class="form-label">Producto</label>
                            <select class="form-select" id="producto_entra" name="producto_entra_id">
                                <option value="">Seleccionar Producto</option>
                                {% for prod in productos %}
                                <option value="{{ prod.id }}">{{ prod.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cantidad_entra" class="form-label">Cantidad (Lts)</label>
                            <input type="number" step="0.01" class="form-control" id="cantidad_entra" name="cantidad_entra">
                        </div>
                         <div class="mb-3">
                            <label for="precio_unitario_canje" class="form-label">Precio de la operación</label>
                            <input type="number" step="0.01" class="form-control" id="precio_unitario_canje" name="precio_unitario_canje" placeholder="Precio del producto que entra">
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-primary">Guardar Movimiento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtros de la Tabla -->
    <div class="card mb-4">
        <div class="card-header">
            Filtros
        </div>
        <div class="card-body">
            <form action="{{ url_for('combustible') }}" method="GET">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filtro_proveedor" class="form-label">Proveedor</label>
                        <select class="form-select" id="filtro_proveedor" name="filtro_proveedor">
                            <option value="">Todos</option>
                            {% for p in proveedores %}
                            <option value="{{ p.cli_c }}" {% if p.cli_c == request.args.get('filtro_proveedor') %}selected{% endif %}>{{ p.s_apelli }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtro_chofer" class="form-label">Chofer</label>
                        <select class="form-select" id="filtro_chofer" name="filtro_chofer">
                            <option value="">Todos</option>
                            {% for c in choferes %}
                            <option value="{{ c.c_document }}" {% if c.c_document == request.args.get('filtro_chofer') %}selected{% endif %}>{{ c.c_nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filtro_producto" class="form-label">Producto</label>
                        <select class="form-select" id="filtro_producto" name="filtro_producto">
                            <option value="">Todos</option>
                            {% for prod in productos %}
                            <option value="{{ prod.id }}" {% if prod.id|string == request.args.get('filtro_producto') %}selected{% endif %}>{{ prod.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filtro_fecha_inicio" class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="filtro_fecha_inicio" name="filtro_fecha_inicio" value="{{ request.args.get('filtro_fecha_inicio', '') }}">
                    </div>
                    <div class="col-md-2">
                        <label for="filtro_fecha_fin" class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="filtro_fecha_fin" name="filtro_fecha_fin" value="{{ request.args.get('filtro_fecha_fin', '') }}">
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-secondary">Filtrar</button>
                    <a href="{{ url_for('combustible') }}" class="btn btn-outline-secondary ms-2">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Movimientos -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            Historial de Movimientos
            <a href="{{ url_for('export_combustible_pdf', **request.args) }}" class="btn btn-success btn-sm">Exportar a PDF</a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Operación</th>
                            <th>Comprobante</th>
                            <th>Proveedor</th>
                            <th>Chofer</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Total</th>
                            <th>Acciones</th> <!-- New column header -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in movimientos %}
                        <tr>
                            <td>{{ mov.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ mov.tipo_operacion }}</td>
                            <td>{{ mov.nro_comprobante }}</td>
                            <td>{{ mov.proveedor_nombre }}</td>
                            <td>{{ mov.chofer_nombre }}</td>
                            <td>{{ mov.producto_nombre }}</td>
                            <td>{{ "%.2f" | format(mov.cantidad) }}</td>
                            <td>${{ "%.2f" | format(mov.precio_unitario) if mov.precio_unitario is not none else '' }}</td>
                            <td>${{ "%.2f" | format(mov.cantidad * mov.precio_unitario) if mov.precio_unitario is not none else '' }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn" data-id="{{ mov.id }}" data-bs-toggle="modal" data-bs-target="#editMovementModal">Editar</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="{{ mov.id }}">Eliminar</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center">No hay movimientos registrados.</td> <!-- colspan updated -->
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Movement Modal -->
<div class="modal fade" id="editMovementModal" tabindex="-1" aria-labelledby="editMovementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMovementModalLabel">Editar Movimiento de Combustible</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-movement-form" method="POST">
                    <input type="hidden" id="edit_movement_id" name="id">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="edit_fecha_movimiento" class="form-label">Fecha del Movimiento</label>
                            <input type="date" class="form-control" id="edit_fecha_movimiento" name="fecha_movimiento" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_tipo_operacion" class="form-label">Tipo de Operación</label>
                            <select class="form-select" id="edit_tipo_operacion" name="tipo_operacion" required disabled>
                                <option value="Compra">Compra</option>
                                <option value="Retiro">Retiro</option>
                                <option value="Canje - Salida">Canje - Salida</option>
                                <option value="Canje - Entrada">Canje - Entrada</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_nro_comprobante" class="form-label">Nro. Comprobante</label>
                            <input type="text" class="form-control" id="edit_nro_comprobante" name="nro_comprobante">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="edit_proveedor" class="form-label">Proveedor</label>
                            <select class="form-select" id="edit_proveedor" name="proveedor_id">
                                <option value="">Seleccionar Proveedor</option>
                                {% for p in proveedores %}
                                <option value="{{ p.cli_c }}">{{ p.s_apelli }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_chofer" class="form-label">Chofer Responsable</label>
                            <select class="form-select" id="edit_chofer" name="chofer_documento" required>
                                <option value="">Seleccionar Chofer</option>
                                {% for c in choferes %}
                                <option value="{{ c.c_document }}">{{ c.c_nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label for="edit_producto" class="form-label">Producto</label>
                            <select class="form-select" id="edit_producto" name="producto_id" required>
                                <option value="">Seleccionar Producto</option>
                                {% for prod in productos %}
                                <option value="{{ prod.id }}">{{ prod.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_cantidad" class="form-label">Cantidad (Lts)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_cantidad" name="cantidad" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_precio_unitario" class="form-label">Precio Unitario</label>
                            <input type="number" step="0.01" class="form-control" id="edit_precio_unitario" name="precio_unitario">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tipoOperacion = document.getElementById('tipo_operacion');
    const canjeSection = document.getElementById('canje-section');
    const productoPrincipalSection = document.getElementById('producto-principal-section');
    const canjeSeparator = document.getElementById('canje-separator');
    
    const productoLabel = document.getElementById('producto-label');
    const cantidadLabel = document.getElementById('cantidad-label');
    const precioLabel = document.getElementById('precio-label');

    const productoPrincipal = document.getElementById('producto');
    const cantidadPrincipal = document.getElementById('cantidad');
    const precioPrincipal = document.getElementById('precio_unitario');

    const productoSale = document.getElementById('producto_sale');
    const cantidadSale = document.getElementById('cantidad_sale');
    const productoEntra = document.getElementById('producto_entra');
    const cantidadEntra = document.getElementById('cantidad_entra');
    const precioCanje = document.getElementById('precio_unitario_canje');


    function toggleSections() {
        if (tipoOperacion.value === 'Canje') {
            canjeSection.style.display = 'flex';
            canjeSeparator.style.display = 'block';
            productoPrincipalSection.style.display = 'none';
            // No son requeridos en modo canje
            productoPrincipal.required = false;
            cantidadPrincipal.required = false;
            // Si son requeridos en modo canje
            productoSale.required = true;
            cantidadSale.required = true;
            productoEntra.required = true;
            cantidadEntra.required = true;

        } else {
            canjeSection.style.display = 'none';
            canjeSeparator.style.display = 'none';
            productoPrincipalSection.style.display = 'flex';
            // Si son requeridos en modo normal
            productoPrincipal.required = true;
            cantidadPrincipal.required = true;
            // No son requeridos en modo normal
            productoSale.required = false;
            cantidadSale.required = false;
            productoEntra.required = false;
            cantidadEntra.required = false;

            if (tipoOperacion.value === 'Compra') {
                productoLabel.textContent = 'Producto Comprado';
                cantidadLabel.textContent = 'Cantidad (Lts)';
                precioLabel.textContent = 'Precio Unitario';
                precioPrincipal.required = true;
            } else if (tipoOperacion.value === 'Retiro') {
                productoLabel.textContent = 'Producto Retirado';
                cantidadLabel.textContent = 'Cantidad (Lts)';
                precioLabel.textContent = 'Precio (Opcional)';
                precioPrincipal.required = false;
            }
        }
    }

    tipoOperacion.addEventListener('change', toggleSections);
    toggleSections(); // Llama al inicio para el estado inicial

    document.getElementById('add-producto-link').addEventListener('click', function(e) {
        e.preventDefault();
        const nombre = prompt('Ingrese el nombre del nuevo producto (ej: Gasoil, Nafta Super):');
        if (nombre) {
            fetch("{{ url_for('add_combustible_producto') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({nombre: nombre})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Agregar a todos los selects de productos
                    [producto, producto_sale, producto_entra].forEach(select_id => {
                        const select = document.getElementById(select_id.id);
                        const option = new Option(data.producto.nombre, data.producto.id);
                        select.add(option);

                    });
                     // Seleccionar el nuevo producto en el dropdown principal
                    document.getElementById('producto').value = data.producto.id;
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    });

    // New JavaScript for Edit and Delete
    const editMovementModal = new bootstrap.Modal(document.getElementById('editMovementModal'));
    const editMovementForm = document.getElementById('edit-movement-form');

    editMovementForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                editMovementModal.hide();
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al guardar los cambios.');
        });
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const movementId = this.dataset.id;
            fetch(`/combustible/get/${movementId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    document.getElementById('edit_movement_id').value = data.id;
                    document.getElementById('edit_fecha_movimiento').value = data.fecha.split('T')[0]; // Assuming ISO format
                    document.getElementById('edit_tipo_operacion').value = data.tipo_operacion;
                    document.getElementById('edit_nro_comprobante').value = data.nro_comprobante;
                    document.getElementById('edit_proveedor').value = data.proveedor_id || '';
                    document.getElementById('edit_chofer').value = data.chofer_documento;
                    document.getElementById('edit_producto').value = data.producto_id;
                    document.getElementById('edit_cantidad').value = parseFloat(data.cantidad).toFixed(2);
                    document.getElementById('edit_precio_unitario').value = parseFloat(data.precio_unitario).toFixed(2);
                    
                    editMovementForm.action = `/combustible/edit/${movementId}`;
                    editMovementModal.show();
                })
                .catch(error => console.error('Error fetching movement data:', error));
        });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const movementId = this.dataset.id;
            if (confirm('¿Estás seguro de que quieres eliminar este movimiento?')) {
                fetch(`/combustible/delete/${movementId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${movementId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload(); // Reload the page to show updated list
                    } else {
                        alert('Error al eliminar el movimiento: ' + data.error);
                    }
                })
                .catch(error => console.error('Error deleting movement:', error));
            }
        });
    });
});
</script>
{% endblock %}
