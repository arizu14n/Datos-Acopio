{% extends "base.html" %}
{% block title %}Fletes - Acopio{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/fletes.css') }}">
{% endblock %}

{% block content %}
    <h1>Fletes</h1>

    <div class="form-container">
        <form method="POST" action="{{ url_for('fletes') }}">
            <div class="filter-group">
                <label>Fechas</label>
                <div class="filter-group-row">
                    <input type="date" id="fecha_desde" name="fecha_desde" class="form-control" value="{{ filtros_aplicados.fecha_desde or '' }}" title="Fecha Desde">
                    <input type="date" id="fecha_hasta" name="fecha_hasta" class="form-control" value="{{ filtros_aplicados.fecha_hasta or '' }}" title="Fecha Hasta">
                </div>
            </div>

            <div class="filter-group">
                <label for="chofer">Chofer</label>
                <div class="filter-group-row">
                    <select id="chofer" name="chofer" class="form-control">
                        <option value="">Todos</option>
                        {% for chofer in choferes %}
                            <option value="{{ chofer[0] }}" {% if filtros_aplicados.chofer == chofer[0] %}selected{% endif %}>{{ chofer[1] }}</option>
                        {% endfor %}
                    </select>
                    {% if nombre_chofer %}
                        <span class="form-control" style="background-color: #eee;">{{ nombre_chofer }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="filter-group">
                <label for="categoria">Categoría</label>
                <div class="filter-group-row">
                    <select id="categoria" name="categoria" class="form-control">
                        <option value="">Todas</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria }}" {% if filtros_aplicados.categoria == categoria %}selected{% endif %}>{{ categoria }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                    <a href="{{ url_for('fletes') }}" class="btn btn-warning">Reiniciar</a>
                    <a href="{{ url_for('importar_fletes_route') }}" class="btn btn-success">Importar Fletes desde DBF</a>
                    <button type="button" id="new-flete-btn" class="btn btn-info">Cargar Flete Manual</button>
                </div>
            </div>
        </form>
    </div>

    {% if resumen_chofer %}
    <div class="summary-container">
        <h2>Resumen del Chofer</h2>
        <a href="{{ url_for('export_resumen_pdf', chofer=filtros_aplicados.chofer, fecha_desde=filtros_aplicados.fecha_desde, fecha_hasta=filtros_aplicados.fecha_hasta) }}" class="btn btn-secondary mb-3" target="_blank">Exportar Resumen a PDF</a>
        <table class="table table-bordered table-striped summary-table">
            <tbody>
                <tr>
                    <th scope="row">Período:</th>
                    <td>Desde: {{ resumen_chofer.periodo_desde }} Hasta: {{ resumen_chofer.periodo_hasta }}</td>
                </tr>
                <tr>
                    <th scope="row">Chofer:</th>
                    <td>{{ resumen_chofer.chofer_nombre }}</td>
                </tr>
                <tr class="table-group-divider">
                    <th colspan="2">Montos Facturados por Categoría:</th>
                </tr>
                <tr>
                    <th scope="row" class="ps-4">ROSARIO</th>
                    <td>{{ format_number(resumen_chofer.rosario, is_currency=True) }}</td>
                </tr>
                <tr>
                    <th scope="row" class="ps-4">HARINA - OTROS</th>
                    <td>{{ format_number(resumen_chofer.harina_otros, is_currency=True) }}</td>
                </tr>
                <tr>
                    <th scope="row" class="ps-4">ARRIMES</th>
                    <td>{{ format_number(resumen_chofer.arrimes, is_currency=True) }}</td>
                </tr>
                <tr>
                    <th scope="row" class="ps-4">IVA (21%)</th>
                    <td>{{ format_number(resumen_chofer.iva, is_currency=True) }}</td>
                </tr>
                <tr class="table-group-divider">
                    <th scope="row">TOTAL FACTURADO</th>
                    <td><strong>{{ format_number(resumen_chofer.total_facturado, is_currency=True) }}</strong></td>
                </tr>
                <tr>
                    <th scope="row">Toneladas transportadas</th>
                    <td>{{ format_number(resumen_chofer.toneladas, decimals=3) }}</td>
                </tr>
                <tr>
                    <th scope="row">Precio promedio por Tonelada</th>
                    <td>{{ format_number(resumen_chofer.precio_prom_ton, is_currency=True) }}</td>
                </tr>
                <tr>
                    <th scope="row">Cantidad de viajes:</th>
                    <td>{{ resumen_chofer.viajes }}</td>
                </tr>
                <tr>
                    <th scope="row">Kilómetros recorridos</th>
                    <td>{{ format_number(resumen_chofer.km, decimals=0) }}</td>
                </tr>
                <tr>
                    <th scope="row">Facturación (Sin IVA) por Km.</th>
                    <td>{{ format_number(resumen_chofer.fact_sin_iva_km, is_currency=True) }}</td>
                </tr>
                <tr>
                    <th scope="row">Facturación (Con IVA) por Km.</th>
                    <td>{{ format_number(resumen_chofer.fact_con_iva_km, is_currency=True) }}</td>
                </tr>
                <tr>
                    <th scope="row">GAS-OIL utilizado (Lts)</th>
                    <td>{{ format_number(resumen_chofer.gasoil, decimals=2) }}</td>
                </tr>
                <tr>
                    <th scope="row">Consumo cada 100 Kms.</th>
                    <td>{{ format_number(resumen_chofer.consumo_100km, decimals=2) }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>CTG</th>
                    <th>Grano</th>
                    <th>Cosecha</th>
                    <th>Categoría</th>
                    <th>Peso Origen</th>
                    <th>Neto</th>
                    <th>Tarifa Flete</th>
                    <th class="importe-col">Importe</th>
                    <th class="km-col">Kilómetros</th>
                    <th></th>
                    <th>Localidad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for flete in fletes %}
                    <tr data-id="{{ flete.id }}">
                        <td>{{ flete.g_fecha }}</td>
                        <td>{{ flete.g_ctg }}</td>
                        <td>{{ flete.grano }}</td>
                        <td>{{ flete.g_cose }}</td>
                        <td>{{ flete.categoria }}</td>
                        <td>{{ flete.o_peso }}</td>
                        <td>{{ flete.o_neto }}</td>
                        <td>{{ flete.g_tarflet }}</td>
                        <td class="importe-col">{{ flete.importe }}</td>
                        <td class="km-col"><input type="text" class="km-input" value="{{ flete.g_kilomet }}"></td>
                        <td><button class="btn btn-primary btn-sm save-km">Guardar</button></td>
                        <td>{{ flete.localidad }}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-flete-btn" data-id="{{ flete.id }}">✏️</button>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="13" style="text-align: center;">No hay datos para mostrar.</td>
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6"><strong>Totales</strong></td>
                    <td id="total-neto"><strong>{{ totales.neto }}</strong></td>
                    <td></td>
                    <td id="total-importe" class="importe-col"><strong>{{ totales.importe }}</strong></td>
                    <td id="total-km" class="km-col"><strong>{{ totales.km }}</strong></td>
                    <td colspan="2"><strong>Viajes: {{ totales.viajes }}</strong></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- The Modal -->
    <div class="modal fade" id="fleteModal" tabindex="-1" aria-labelledby="fleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="fleteModalLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="fleteForm" method="POST">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="g_fecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="g_fecha" name="g_fecha" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="g_ctg" class="form-label">CTG</label>
                        <input type="text" class="form-control" id="g_ctg" name="g_ctg" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="g_cuilchof" class="form-label">Chofer</label>
                        <select class="form-select" id="g_cuilchof" name="g_cuilchof" required>
                            <option selected disabled value="">Seleccionar...</option>
                            {% for cuil, nombre in all_choferes.items() %}
                            <option value="{{ cuil }}">{{ nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="g_codi" class="form-label">Grano</label>
                        <select class="form-select" id="g_codi" name="g_codi" required>
                            <option selected disabled value="">Seleccionar...</option>
                            {% for codigo, desc in granos.items() %}
                            <option value="{{ codigo }}">{{ desc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="g_cose" class="form-label">Cosecha</label>
                        <input type="text" class="form-control" id="g_cose" name="g_cose">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="categoria" class="form-label">Categoría</label>
                        <select class="form-select" id="categoria" name="categoria">
                            <option selected disabled value="">Seleccionar...</option>
                            {% for cat in categorias %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="g_ctaplade" class="form-label">Localidad</label>
                        <select class="form-select" id="g_ctaplade" name="g_ctaplade">
                            <option selected disabled value="">Seleccionar...</option>
                            {% for codigo, nombre in localidades.items() %}
                            <option value="{{ codigo }}">{{ nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="o_peso" class="form-label">Peso Origen</label>
                        <input type="number" step="0.01" class="form-control" id="o_peso" name="o_peso" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="o_neto" class="form-label">Neto</label>
                        <input type="number" step="0.01" class="form-control" id="o_neto" name="o_neto" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="g_tarflet" class="form-label">Tarifa</label>
                        <input type="number" step="0.01" class="form-control" id="g_tarflet" name="g_tarflet" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="g_kilomet" class="form-label">Kilómetros</label>
                        <input type="number" class="form-control" id="g_kilomet" name="g_kilomet" required>
                    </div>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="deleteFleteBtn" class="btn btn-danger" style="display: none;">Eliminar</button>
            <button type="submit" form="fleteForm" class="btn btn-primary save-btn">Guardar</button>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    const updateKmUrl = "{{ url_for('update_km') }}";
    const nuevoFleteUrl = "{{ url_for('nuevo_flete') }}";
</script>
<script src="{{ url_for('static', filename='js/fletes.js') }}"></script>
{% endblock %}
